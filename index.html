<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الاشتراكات (تسجيل دخول جوجل - مقيد)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #eef2f7; 
            color: #334155; 
        }
        .main-container {
            max-width: 1200px;
            margin: auto;
            padding: 1rem;
        }
        @media (min-width: 640px) { .main-container { padding: 1.5rem; } }
        @media (min-width: 1024px) { .main-container { padding: 2rem; } }

        .header-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.25,0.8,0.25,1);
        }
        .subscription-card {
            background-color: #ffffff;
            border-radius: 12px; 
            border-right-width: 5px; 
            position: relative;
            overflow: hidden;
        }
        .subscription-card:hover {
            transform: translateY(-6px) scale(1.01); 
            box-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.15), 0 10px 15px -8px rgba(0, 0, 0, 0.1);
        }
        .subscription-card::before {
            content: ''; position: absolute; top: -50px; left: -50px; 
            width: 150px; height: 150px;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.08) 0%, rgba(102, 126, 234, 0) 70%);
            opacity: 0.5; transition: opacity 0.3s ease;
        }
        .subscription-card:hover::before { opacity: 0.8; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { 
            background-color: #fff; margin: 10% auto; padding: 30px; 
            border: none; width: 90%; max-width: 580px; 
            border-radius: 12px; box-shadow: 0 15px 30px rgba(0,0,0,0.2); 
            transform: scale(0.95); opacity: 0; animation: modalAppear 0.3s ease-out forwards;
        }
        @keyframes modalAppear { to { transform: scale(1); opacity: 1; } }
        .tab-button { padding: 0.75rem 1.25rem; font-weight: 600; border-bottom-width: 3px; transition: all 0.2s ease-in-out; }
        .tab-button.active-tab { border-color: #4f46e5; color: #4f46e5; background-color: rgba(79, 70, 229, 0.05); }
        .tab-button:not(.active-tab):hover { background-color: rgba(100, 116, 139, 0.05); border-bottom-color: #cbd5e1; }
        .stat-badge { 
            min-width: 26px; height: 26px; line-height: 26px; 
            display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem; 
        }
        .loader {
            border: 4px solid #e0e7ff; border-top: 4px solid #4f46e5; 
            border-radius: 50%; width: 20px; height: 20px;
            animation: spin 0.8s linear infinite; display: inline-block; margin-left: 8px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input[type="tel"], input[type="text"], select, textarea {
            border-radius: 8px; border-color: #cbd5e1; padding: 0.85rem 1rem; transition: all 0.2s ease-in-out;
        }
        input[type="tel"]:focus, input[type="text"]:focus, select:focus, textarea:focus {
            border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); 
        }
        button {
            border-radius: 8px; padding-top: 0.75rem; padding-bottom: 0.75rem;
            font-weight: 600; transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); 
        }
        button:hover {
            transform: translateY(-2px); 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.1);
        }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #e2e8f0; color: #334155; }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-success { background-color: #16a34a; color: white; }
        .btn-success:hover { background-color: #15803d; }
        .btn-info { background-color: #0ea5e9; color: white; }
        .btn-info:hover { background-color: #0284c7; }
        button i { margin-left: 0.5rem; margin-right: 0; }
        #notificationArea > div { box-shadow: 0 10px 20px rgba(0,0,0,0.15); border-radius: 8px; font-size: 0.9rem; }
        #authContainer button.google-signin-btn { 
            background-color: #db4437; 
            color: white;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }
        #authContainer button.google-signin-btn:hover {
            background-color: #c33d2e;
        }
        #userInfo {
            font-size: 0.8rem;
            padding: 0.5rem 1rem;
            background-color: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        #userInfo img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px; 
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-700">

    <div id="confirmationModal" class="modal"> <div class="modal-content"> <h3 class="text-xl font-semibold mb-4 text-slate-800" id="confirmModalTitle">هل أنت متأكد؟</h3> <p id="modalMessage" class="text-slate-600 mb-6">سيتم تنفيذ هذا الإجراء.</p> <div class="flex justify-end gap-3"> <button id="cancelAction" class="btn-secondary px-5">إلغاء</button> <button id="confirmAction" class="btn-danger px-5">تأكيد</button> </div> </div> </div>
    <div id="editNoteModal" class="modal"> <div class="modal-content"> <h3 class="text-xl font-semibold mb-6 text-slate-800" id="editNoteModalTitle">تعديل المشترك</h3> <input type="hidden" id="editSubId"> <div class="mb-5"> <label for="editCustomerPhone" class="block text-sm font-medium text-slate-600 mb-1">رقم الهاتف:</label> <input type="tel" id="editCustomerPhone" class="w-full"> </div> <div class="mb-6"> <label for="editCustomerNotes" class="block text-sm font-medium text-slate-600 mb-1">ملاحظات:</label> <textarea id="editCustomerNotes" rows="3" class="w-full" placeholder="أضف ملاحظات هنا..."></textarea> </div> <div class="flex justify-end gap-3"> <button id="cancelEditNote" class="btn-secondary px-5">إلغاء</button> <button id="saveEditNote" class="btn-primary px-5">حفظ التغييرات</button> </div> </div> </div>
    <div id="notificationArea" class="fixed top-5 left-5 z-[1001] w-full max-w-xs sm:max-w-sm p-4 sm:p-0"></div>

    <div class="main-container">
        <header class="text-center mb-10 py-6 sm:py-8 header-gradient text-white rounded-xl card-shadow">
            <div class="flex justify-center items-center mb-2">
                 <i class="fas fa-rocket fa-2x mr-3 transform -scale-x-100"></i>
                <h1 class="text-3xl sm:text-4xl font-bold">نظام إدارة الاشتراكات</h1>
            </div>
            <p class="opacity-80 mt-1 text-sm sm:text-base">إدارة شاملة لاشتراكات عملائك بكفاءة وفعالية.</p>
            
            <div id="authContainer" class="mt-4">
                {/* سيتم ملء هذا بزر تسجيل الدخول أو معلومات المستخدم */}
            </div>
        </header>

        <div id="mainContent" class="hidden"> 
            <div class="mb-10 p-6 sm:p-8 bg-white rounded-xl card-shadow">
                <h2 class="text-2xl font-semibold mb-6 text-indigo-700 flex items-center">
                    <i class="fas fa-user-plus mr-3 text-xl"></i>إدارة المشتركين
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5 items-end">
                    <div class="md:col-span-2">
                        <label for="customerPhone" class="block text-sm font-medium text-slate-600 mb-1">رقم هاتف العميل:</label>
                        <input type="tel" id="customerPhone" placeholder="مثال: 07701234567" class="w-full" />
                    </div>
                    <button id="addSubscriberBtn" class="btn-primary w-full py-3 px-6 flex items-center justify-center">
                        <i class="fas fa-plus-circle"></i>إضافة مشترك
                        <span id="addSubscriberLoader" class="loader hidden"></span>
                    </button>
                </div>
                 <div class="mt-8">
                    <label for="searchInput" class="block text-sm font-medium text-slate-600 mb-1">
                        <i class="fas fa-search mr-2 opacity-70"></i>بحث برقم الهاتف:
                    </label>
                    <input type="text" id="searchInput" placeholder="أدخل جزء من الرقم للبحث..." class="w-full">
                </div>
            </div>
            
            <div class="mb-8 flex flex-col sm:flex-row justify-between items-center gap-4 p-5 bg-white rounded-xl card-shadow">
                <div>
                    <label for="sortOptions" class="text-sm font-medium text-slate-600 mr-2"><i class="fas fa-sort-amount-down mr-1 opacity-70"></i>فرز حسب:</label>
                    <select id="sortOptions" class="text-sm">
                        <option value="expiryDateAsc">تاريخ الانتهاء (الأقرب أولاً)</option>
                        <option value="expiryDateDesc">تاريخ الانتهاء (الأبعد أولاً)</option>
                        <option value="createdAtDesc">تاريخ الإضافة (الأحدث أولاً)</option>
                        <option value="createdAtAsc">تاريخ الإضافة (الأقدم أولاً)</option>
                    </select>
                </div>
                <button id="exportCsvBtn" class="btn-success py-2 px-5 text-sm">
                    <i class="fas fa-file-csv"></i>تصدير المحدد (CSV)
                </button>
            </div>

            <div class="mb-6">
                <nav class="flex flex-wrap -mb-px border-b border-slate-300" aria-label="Tabs">
                    <button data-tab="active" class="tab-button active-tab"> <i class="fas fa-stream mr-2"></i>النشطة <span id="activeCount" class="bg-green-500 text-white text-xs font-semibold mr-1 px-2 py-0.5 rounded-full stat-badge">0</span> </button>
                    <button data-tab="expired" class="tab-button text-slate-500"> <i class="fas fa-hourglass-half mr-2"></i>المنتهية <span id="expiredCount" class="bg-red-500 text-white text-xs font-semibold mr-1 px-2 py-0.5 rounded-full stat-badge">0</span> </button>
                    <button data-tab="removed" class="tab-button text-slate-500"> <i class="fas fa-trash-alt mr-2"></i>المزالة <span id="removedCount" class="bg-slate-400 text-white text-xs font-semibold mr-1 px-2 py-0.5 rounded-full stat-badge">0</span> </button>
                </nav>
            </div>

            <div id="subscriptionsContainer" class="min-h-[250px] pb-10">
                <div id="activeSubscriptions" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 sm:gap-6 tab-content"></div>
                <div id="expiredSubscriptions" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 sm:gap-6 tab-content hidden"></div>
                <div id="removedSubscriptions" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 sm:gap-6 tab-content hidden"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, serverTimestamp, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // !! مهم جداً: استبدل هذا الرابط بعنوان URL الفعلي لدالة notifyNewSubscriber بعد نشرها !!
        const NOTIFY_NEW_SUBSCRIBER_FUNCTION_URL = "https://notifynewsubscriber-3mkobbduaa-uc.a.run.app"; // <--- ضع هنا رابط دالة الإشعار
        const ALLOWED_EMAIL = "soso.lovr66@gmail.com"; // <--- البريد الإلكتروني الوحيد المسموح له بالوصول

        setLogLevel('info'); // 'debug' or 'silent' for production

        // !! مهم جداً: استبدل هذه القيم بقيم مشروع Firebase الخاص بك !!
        const firebaseConfigFromUser = {
            apiKey: "AIzaSyCKGjIRLL0nZbuYRBkqNG7I0c1yf5SkwMk", // استبدل
            authDomain: "login-72424.firebaseapp.com",    // استبدل
            projectId: "login-72424",                 // استبدل
            storageBucket: "login-72424.appspot.com", // استبدل (عادة .appspot.com)
            messagingSenderId: "891002963088",         // استبدل
            appId: "1:891002963088:web:d872167dbc464403528415", // استبدل
            measurementId: "G-CFLK1QXKDF" // اختياري, استبدل
        };
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfigFromUser;


        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        const dynamicAppId = firebaseConfig.appId || 'default-app-id'; // استخدام appId من firebaseConfig
        let userId = null; 
        let allSubscriptions = [];
        let currentSortOption = 'expiryDateAsc';
        let currentFilterQuery = '';
        let currentVisibleTab = 'active';

        const authContainer = document.getElementById('authContainer');
        const mainContentDiv = document.getElementById('mainContent');
        const customerPhoneInput = document.getElementById('customerPhone');
        const addSubscriberBtn = document.getElementById('addSubscriberBtn');
        const addSubscriberLoader = document.getElementById('addSubscriberLoader');
        // ... (باقي تعريفات DOM Elements كما هي) ...
        const searchInput = document.getElementById('searchInput');
        const sortOptionsSelect = document.getElementById('sortOptions');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const activeSubscriptionsDiv = document.getElementById('activeSubscriptions');
        const expiredSubscriptionsDiv = document.getElementById('expiredSubscriptions');
        const removedSubscriptionsDiv = document.getElementById('removedSubscriptions');
        const activeCountSpan = document.getElementById('activeCount');
        const expiredCountSpan = document.getElementById('expiredCount');
        const removedCountSpan = document.getElementById('removedCount');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmModalTitle = document.getElementById('confirmModalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const confirmActionBtn = document.getElementById('confirmAction');
        const cancelActionBtn = document.getElementById('cancelAction');
        let currentConfirmActionCallback = null;
        const editNoteModal = document.getElementById('editNoteModal');
        const editNoteModalTitle = document.getElementById('editNoteModalTitle');
        const editSubIdInput = document.getElementById('editSubId');
        const editCustomerPhoneInput = document.getElementById('editCustomerPhone');
        const editCustomerNotesTextarea = document.getElementById('editCustomerNotes');
        const saveEditNoteBtn = document.getElementById('saveEditNote');
        const cancelEditNoteBtn = document.getElementById('cancelEditNote');


        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (user.email === ALLOWED_EMAIL) {
                    userId = user.uid;
                    console.log("Allowed user signed in:", user.displayName, user.email, user.uid);
                    authContainer.innerHTML = `
                        <div id="userInfo" class="flex items-center justify-center text-white">
                            ${user.photoURL ? `<img src="${user.photoURL}" alt="Profile Picture">` : '<i class="fas fa-user-circle fa-lg mr-2"></i>'}
                            <span class="mr-2">${user.displayName || user.email}</span>
                            <button id="signOutBtn" class="btn-secondary text-xs py-1 px-3 bg-white/20 hover:bg-white/30">تسجيل الخروج</button>
                        </div>
                        <p class="text-xs opacity-70 mt-1">معرف المستخدم: <span class="font-mono">${userId}</span></p>
                    `;
                    document.getElementById('signOutBtn').addEventListener('click', async () => {
                        try { await signOut(auth); } catch (error) { console.error("Error signing out:", error); showInPageNotification("خطأ أثناء تسجيل الخروج.", "error");}
                    });
                    mainContentDiv.classList.remove('hidden');
                    loadAndListenSubscriptions();
                } else {
                    console.warn("Unauthorized user attempted sign-in:", user.email);
                    authContainer.innerHTML = `
                        <p class="text-red-200 text-sm p-2 bg-red-700/50 rounded-md">عذرًا، البريد الإلكتروني (${user.email}) غير مصرح له باستخدام هذا النظام.</p>
                        <button id="signOutBtnUnauthorized" class="btn-secondary text-xs py-1 px-3 mt-2 bg-white/20 hover:bg-white/30">تسجيل الخروج</button>
                    `;
                    if(document.getElementById('signOutBtnUnauthorized')) { // التأكد من وجود الزر قبل إضافة المستمع
                        document.getElementById('signOutBtnUnauthorized').addEventListener('click', async () => { await signOut(auth); });
                    }
                    mainContentDiv.classList.add('hidden');
                    allSubscriptions = []; renderSubscriptions(); userId = null; 
                }
            } else {
                userId = null;
                console.log("User is signed out.");
                authContainer.innerHTML = `
                    <button id="signInBtn" class="google-signin-btn py-2 px-6">
                        <i class="fab fa-google mr-2"></i> تسجيل الدخول باستخدام جوجل
                    </button>
                `;
                document.getElementById('signInBtn').addEventListener('click', async () => {
                    try { await signInWithPopup(auth, googleProvider); } 
                    catch (error) { 
                        console.error("Error during Google sign-in:", error);
                        let errorMessage = "فشل تسجيل الدخول باستخدام جوجل.";
                        if (error.code === 'auth/popup-closed-by-user') errorMessage = "تم إغلاق نافذة تسجيل الدخول.";
                        else if (error.code === 'auth/cancelled-popup-request') return; 
                        showInPageNotification(errorMessage, "error");
                    }
                });
                mainContentDiv.classList.add('hidden');
                allSubscriptions = []; renderSubscriptions(); 
            }
        });
        
        function showInPageNotification(message, type = 'info', duration = 4500) {
            const area = document.getElementById('notificationArea');
            const id = `inpage-notif-${Date.now()}`;
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `p-4 mb-3 rounded-lg shadow-xl text-white text-sm transform transition-all duration-300 ease-out opacity-0 translate-x-full`;
            if (type === 'error') notificationDiv.classList.add('bg-red-500');
            else if (type === 'success') notificationDiv.classList.add('bg-green-500');
            else if (type === 'warning') notificationDiv.classList.add('bg-yellow-500', 'text-yellow-800');
            else notificationDiv.classList.add('bg-indigo-500');
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '<i class="fas fa-times"></i>';
            closeBtn.className = 'mr-3 float-left text-lg leading-none hover:text-white/70 transition-colors';
            closeBtn.onclick = () => {
                notificationDiv.classList.replace('opacity-100', 'opacity-0');
                notificationDiv.classList.replace('translate-x-0', 'translate-x-full');
                setTimeout(() => notificationDiv.remove(), 300);
            };
            const msgSpan = document.createElement('span');
            msgSpan.textContent = message;
            notificationDiv.appendChild(closeBtn);
            notificationDiv.appendChild(msgSpan);
            area.appendChild(notificationDiv);
            setTimeout(() => {
                notificationDiv.classList.replace('opacity-0', 'opacity-100');
                notificationDiv.classList.replace('translate-x-full', 'translate-x-0');
            }, 50);
            setTimeout(() => { closeBtn.click(); }, duration);
        }
        
        addSubscriberBtn.addEventListener('click', async () => {
            const phoneNumber = customerPhoneInput.value.trim();
            if (!phoneNumber || !/^\d{10,15}$/.test(phoneNumber)) { showInPageNotification("الرجاء إدخال رقم هاتف صحيح.", 'error'); return; }
            if (!userId || (auth.currentUser && auth.currentUser.email !== ALLOWED_EMAIL)) { 
                showInPageNotification("خطأ: يجب تسجيل الدخول بحساب مصرح به لإضافة مشترك.", 'error'); return;
            }

            addSubscriberBtn.disabled = true;
            addSubscriberLoader.classList.remove('hidden');
            const originalButtonText = addSubscriberBtn.querySelector('i').nextSibling.textContent.trim(); 
            addSubscriberBtn.childNodes[1].textContent = ' جارٍ الإضافة... ';

            const startDate = new Date();
            const expiryDate = new Date();
            expiryDate.setDate(startDate.getDate() + 30);

            try {
                await addDoc(collection(db, `artifacts/${dynamicAppId}/users/${userId}/subscriptions`), {
                    phoneNumber, 
                    startDate: Timestamp.fromDate(startDate), 
                    expiryDate: Timestamp.fromDate(expiryDate),
                    status: "active", 
                    notes: "", 
                    createdAt: serverTimestamp() 
                });
                customerPhoneInput.value = '';
                showInPageNotification("تمت إضافة المشترك بنجاح إلى Firestore!", 'success');

                if (NOTIFY_NEW_SUBSCRIBER_FUNCTION_URL && NOTIFY_NEW_SUBSCRIBER_FUNCTION_URL !== "YOUR_NOTIFY_NEW_SUBSCRIBER_FUNCTION_URL_HERE") {
                    fetch(NOTIFY_NEW_SUBSCRIBER_FUNCTION_URL, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ phoneNumber, startDate: startDate.toISOString(), expiryDate: expiryDate.toISOString() }),
                    }).then(async response => {
                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) showInPageNotification("تم إرسال إشعار إضافة المشترك إلى تليجرام.", 'info');
                            else showInPageNotification("فشل إرسال إشعار تليجرام: " + (result.message || "خطأ غير معروف"), 'error');
                        } else {
                            const errorText = await response.text();
                            showInPageNotification(`خطأ استدعاء دالة تليجرام: ${response.status} ${errorText}`, 'error', 7000);
                        }
                    }).catch(teleError => {
                        console.error("Error calling notifyNewSubscriber function:", teleError);
                        showInPageNotification(`فشل الاتصال بدالة إشعار تليجرام: ${teleError.message}`, 'error', 7000);
                    });
                } else {
                     showInPageNotification("تنبيه: رابط دالة إشعار تليجرام غير مكون.", "warning", 6000);
                }
            } catch (error) {
                console.error("Error adding subscriber to Firestore: ", error);
                if (error.code === 'permission-denied' || error.message.toLowerCase().includes('permission-denied')) {
                     showInPageNotification(`خطأ إضافة مشترك: أذونات غير كافية. تأكد من قواعد الأمان.`, 'error', 10000);
                } else {
                    showInPageNotification(`خطأ إضافة مشترك: ${error.message}`, 'error');
                }
            } finally {
                addSubscriberBtn.disabled = false;
                addSubscriberLoader.classList.add('hidden');
                addSubscriberBtn.childNodes[1].textContent = ` ${originalButtonText} `;
            }
        });

        function showConfirmationModal(title, message, actionCallback, confirmButtonClass = 'btn-danger') {
            confirmModalTitle.textContent = title;
            modalMessage.textContent = message;
            confirmActionBtn.className = `font-semibold py-2 px-5 rounded-lg transition ${confirmButtonClass}`;
            confirmationModal.style.display = 'flex';
            currentConfirmActionCallback = actionCallback;
        }
        confirmActionBtn.onclick = () => { if (currentConfirmActionCallback) currentConfirmActionCallback(); closeConfirmationModal(); };
        cancelActionBtn.onclick = closeConfirmationModal;
        function closeConfirmationModal() { confirmationModal.style.display = 'none'; currentConfirmActionCallback = null; }

        function openEditNoteModal(sub) {
            editNoteModalTitle.textContent = `تعديل بيانات: ${sub.phoneNumber}`;
            editSubIdInput.value = sub.id;
            editCustomerPhoneInput.value = sub.phoneNumber;
            editCustomerNotesTextarea.value = sub.notes || '';
            editNoteModal.style.display = 'flex';
        }
        saveEditNoteBtn.onclick = async () => {
            const subId = editSubIdInput.value;
            const newPhoneNumber = editCustomerPhoneInput.value.trim();
            const newNotes = editCustomerNotesTextarea.value.trim();
            if (!newPhoneNumber || !/^\d{10,15}$/.test(newPhoneNumber)) { showInPageNotification("الرجاء إدخال رقم هاتف صحيح.", 'error'); return; }
            if (!userId || !subId || (auth.currentUser && auth.currentUser.email !== ALLOWED_EMAIL)) { 
                showInPageNotification("خطأ: لا يمكن حفظ التغييرات. تأكد من تسجيل الدخول بحساب مصرح به.", 'error'); return; 
            }
            const subDocRef = doc(db, `artifacts/${dynamicAppId}/users/${userId}/subscriptions`, subId);
            try {
                await updateDoc(subDocRef, { phoneNumber: newPhoneNumber, notes: newNotes });
                showInPageNotification("تم حفظ التغييرات بنجاح!", 'success');
                closeEditNoteModal();
            } catch (error) { console.error("Error updating details:", error); showInPageNotification(`خطأ: ${error.message}`, 'error');}
        };
        cancelEditNoteBtn.onclick = closeEditNoteModal;
        function closeEditNoteModal() { editNoteModal.style.display = 'none'; }
        window.onclick = (event) => {
            if (event.target == confirmationModal) closeConfirmationModal();
            if (event.target == editNoteModal) closeEditNoteModal();
        };
        
        searchInput.addEventListener('input', (e) => { currentFilterQuery = e.target.value.toLowerCase(); renderSubscriptions(); });
        sortOptionsSelect.addEventListener('change', (e) => { currentSortOption = e.target.value; renderSubscriptions(); });
        
        function loadAndListenSubscriptions() {
            if (!userId) { allSubscriptions = []; renderSubscriptions(); return; }
            const path = `artifacts/${dynamicAppId}/users/${userId}/subscriptions`; 
            const q = query(collection(db, path));
            onSnapshot(q, async (querySnapshot) => {
                const now = new Date();
                const subsToUpdateStatus = [];
                allSubscriptions = querySnapshot.docs.map(docSnapshot => {
                    const sub = { id: docSnapshot.id, ...docSnapshot.data() };
                    if (sub.status === "active" && sub.expiryDate.toDate() < now) {
                        subsToUpdateStatus.push({ id: sub.id, newStatus: "expired" });
                        sub.status = "expired"; 
                    }
                    return sub;
                });
                if (subsToUpdateStatus.length > 0) {
                    const batch = writeBatch(db);
                    subsToUpdateStatus.forEach(s => batch.update(doc(db, path, s.id), { status: s.newStatus }));
                    try { await batch.commit(); } catch (err) { console.error("Error batch updating statuses:", err); }
                }
                renderSubscriptions();
            }, (error) => { console.error("Error fetching subscriptions:", error); showInPageNotification(`خطأ جلب الاشتراكات: ${error.message}`, 'error'); });
        }

        function renderSubscriptions() {
            let filteredSubs = [...allSubscriptions];
            if (currentFilterQuery) {
                filteredSubs = filteredSubs.filter(sub => sub.phoneNumber.includes(currentFilterQuery));
            }
            filteredSubs.sort((a, b) => {
                const dateA = a.expiryDate.toDate();
                const dateB = b.expiryDate.toDate();
                const createdA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                const createdB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                switch (currentSortOption) {
                    case 'expiryDateDesc': return dateB - dateA;
                    case 'createdAtAsc': return createdA - createdB;
                    case 'createdAtDesc': return createdB - createdA;
                    default: return dateA - dateB;
                }
            });
            
            [activeSubscriptionsDiv, expiredSubscriptionsDiv, removedSubscriptionsDiv].forEach(div => div.innerHTML = '');
            let activeC = 0, expiredC = 0, removedC = 0;
            const placeholderText = (text) => `<div class="col-span-full text-center text-slate-500 py-10"><i class="fas fa-info-circle fa-2x mb-3 text-slate-400"></i><p>${text}</p></div>`;

            if (!userId || (auth.currentUser && auth.currentUser.email !== ALLOWED_EMAIL) ) { 
                const authMessage = auth.currentUser && auth.currentUser.email !== ALLOWED_EMAIL ? 
                                    `البريد الإلكتروني (${auth.currentUser.email}) غير مصرح له بالوصول. يرجى تسجيل الخروج والمحاولة بالبريد المسموح به.` :
                                    'يرجى تسجيل الدخول باستخدام جوجل للبدء.';
                [activeSubscriptionsDiv, expiredSubscriptionsDiv, removedSubscriptionsDiv].forEach(div => div.innerHTML = placeholderText(authMessage));
                activeCountSpan.textContent = 0; expiredCountSpan.textContent = 0; removedCountSpan.textContent = 0;
                return;
            }

            if (filteredSubs.length === 0 && allSubscriptions.length > 0 && currentFilterQuery) {
                 [activeSubscriptionsDiv, expiredSubscriptionsDiv, removedSubscriptionsDiv].forEach(div => div.innerHTML = placeholderText('لا توجد نتائج بحث مطابقة.'));
            } else if (allSubscriptions.length === 0 && userId) { 
                 [activeSubscriptionsDiv, expiredSubscriptionsDiv, removedSubscriptionsDiv].forEach(div => div.innerHTML = placeholderText('لا توجد اشتراكات. ابدأ بإضافة مشترك جديد!'));
            }

            filteredSubs.forEach(sub => {
                const card = createSubscriptionCard(sub);
                if (sub.status === "active") { activeSubscriptionsDiv.appendChild(card); activeC++; }
                else if (sub.status === "expired") { expiredSubscriptionsDiv.appendChild(card); expiredC++; }
                else if (sub.status === "removed") { removedSubscriptionsDiv.appendChild(card); removedC++; }
            });
            
            activeCountSpan.textContent = activeC;
            expiredCountSpan.textContent = expiredC;
            removedCountSpan.textContent = removedC;

            if (userId) { 
                if (activeC === 0 && (currentVisibleTab === 'active' || !currentFilterQuery) && allSubscriptions.length > 0 && filteredSubs.length > 0) activeSubscriptionsDiv.innerHTML = activeSubscriptionsDiv.innerHTML || placeholderText('لا توجد اشتراكات نشطة حالياً.');
                else if (activeC === 0 && filteredSubs.length === 0 && !currentFilterQuery) activeSubscriptionsDiv.innerHTML = placeholderText('لا توجد اشتراكات نشطة حالياً.');

                if (expiredC === 0 && (currentVisibleTab === 'expired' || !currentFilterQuery) && allSubscriptions.length > 0 && filteredSubs.length > 0) expiredSubscriptionsDiv.innerHTML = expiredSubscriptionsDiv.innerHTML || placeholderText('لا توجد اشتراكات منتهية حالياً.');
                else if (expiredC === 0 && filteredSubs.length === 0 && !currentFilterQuery) expiredSubscriptionsDiv.innerHTML = placeholderText('لا توجد اشتراكات منتهية حالياً.');
                
                if (removedC === 0 && (currentVisibleTab === 'removed' || !currentFilterQuery) && allSubscriptions.length > 0 && filteredSubs.length > 0) removedSubscriptionsDiv.innerHTML = removedSubscriptionsDiv.innerHTML || placeholderText('لا توجد اشتراكات تمت إزالتها.');
                else if (removedC === 0 && filteredSubs.length === 0 && !currentFilterQuery) removedSubscriptionsDiv.innerHTML = placeholderText('لا توجد اشتراكات تمت إزالتها.');
            }
        }

        function createSubscriptionCard(subscription) {
            const card = document.createElement('div');
            card.className = 'subscription-card p-5 sm:p-6 card-shadow flex flex-col justify-between min-h-[220px]'; 
            const expiryDate = subscription.expiryDate.toDate();
            const startDate = subscription.startDate.toDate();
            const now = new Date();
            const daysRemaining = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
            let statusText = "", statusColorClass = "", iconClass = "", textColorClass = "";

            if (subscription.status === "active") {
                if (daysRemaining > 7) { statusText = `نشط - متبقي ${daysRemaining} يوم`; statusColorClass = 'border-green-500'; iconClass = 'fas fa-check-circle text-green-500'; textColorClass = 'text-green-600';}
                else if (daysRemaining > 0) { statusText = `نشط - سينتهي خلال ${daysRemaining} يوم!`; statusColorClass = 'border-yellow-500'; iconClass = 'fas fa-exclamation-triangle text-yellow-500'; textColorClass = 'text-yellow-600';}
                else { statusText = "منتهي (راجع الحالة)"; statusColorClass = 'border-red-500'; iconClass = 'fas fa-times-circle text-red-500'; textColorClass = 'text-red-600';}
            } else if (subscription.status === "expired") {
                statusText = "منتهي - يتطلب إجراء"; statusColorClass = 'border-red-500'; iconClass = 'fas fa-hourglass-end text-red-500'; textColorClass = 'text-red-600';
            } else if (subscription.status === "removed") {
                statusText = "تمت الإزالة"; statusColorClass = 'border-slate-400'; iconClass = 'fas fa-user-slash text-slate-500'; textColorClass = 'text-slate-500';
            }
            card.classList.add(statusColorClass);

            card.innerHTML = `
                <div>
                    <div class="flex items-center mb-2">
                        <i class="${iconClass} ml-2 text-xl"></i>
                        <h3 class="text-xl font-bold text-indigo-700 truncate" title="${subscription.phoneNumber}">${subscription.phoneNumber}</h3>
                    </div>
                    <p class="text-xs text-slate-500 mb-0.5">تاريخ البدء: ${startDate.toLocaleDateString('ar-EG', { day: '2-digit', month: 'short', year: 'numeric' })}</p>
                    <p class="text-xs text-slate-600 font-medium">تاريخ الانتهاء: ${expiryDate.toLocaleDateString('ar-EG', { day: '2-digit', month: 'short', year: 'numeric' })}</p>
                    <p class="text-sm font-semibold mt-2 ${textColorClass}">${statusText}</p>
                    ${subscription.notes ? `<p class="text-xs text-slate-500 mt-2.5 bg-slate-100 p-2 rounded-md break-words"><i class="fas fa-sticky-note ml-1 text-slate-400"></i>${subscription.notes}</p>` : ''}
                </div>
                <div class="mt-4 pt-4 border-t border-slate-200 flex flex-wrap gap-2 justify-end items-center">
                    <button data-id="${subscription.id}" class="edit-btn text-xs text-indigo-600 hover:text-indigo-800 py-1 px-2 rounded-md hover:bg-indigo-50 transition" title="تعديل/إضافة ملاحظة"><i class="fas fa-edit fa-fw"></i> تعديل</button>
                    ${subscription.status !== "removed" ? `<button data-id="${subscription.id}" class="mark-removed-btn btn-danger text-xs py-1 px-2"><i class="fas fa-times-circle fa-fw ml-1"></i>إزالة</button>` : ''}
                    ${subscription.status === "removed" ? `<button data-id="${subscription.id}" class="reactivate-btn btn-success text-xs py-1 px-2"><i class="fas fa-check-circle fa-fw ml-1"></i>إعادة تفعيل</button>` : ''}
                    ${subscription.status === "expired" ? `<button data-id="${subscription.id}" data-current-expiry="${expiryDate.toISOString()}" class="renew-btn btn-info text-xs py-1 px-2"><i class="fas fa-history fa-fw ml-1"></i>تجديد</button>` : ''}
                </div>
            `;
            card.querySelector('.edit-btn').addEventListener('click', () => openEditNoteModal(subscription));
            const markRemovedBtn = card.querySelector('.mark-removed-btn');
            if (markRemovedBtn) markRemovedBtn.addEventListener('click', () => showConfirmationModal('تأكيد الإزالة', `هل تريد وضع علامة "تمت الإزالة" على ${subscription.phoneNumber}؟`, () => updateSubscriptionStatus(subscription.id, "removed"), 'btn-danger'));
            const reactivateBtn = card.querySelector('.reactivate-btn');
            if (reactivateBtn) reactivateBtn.addEventListener('click', () => showConfirmationModal('إعادة تفعيل الاشتراك', `إعادة تفعيل ${subscription.phoneNumber}؟ سيبدأ اشتراك جديد لـ30 يوم.`, () => {
                const newExpiry = new Date(); newExpiry.setDate(new Date().getDate() + 30);
                updateSubscriptionStatus(subscription.id, "active", Timestamp.fromDate(newExpiry), Timestamp.fromDate(new Date()));
            }, 'btn-success'));
            const renewBtn = card.querySelector('.renew-btn');
            if (renewBtn) renewBtn.addEventListener('click', () => {
                const currentExpiry = new Date(renewBtn.dataset.currentExpiry);
                const newExpiry = new Date(currentExpiry); newExpiry.setDate(currentExpiry.getDate() + 30);
                showConfirmationModal('تجديد الاشتراك', `تجديد اشتراك ${subscription.phoneNumber} لـ30 يوم إضافية؟ سينتهي في ${newExpiry.toLocaleDateString('ar-EG')}.`, () => {
                    updateSubscriptionStatus(subscription.id, "active", Timestamp.fromDate(newExpiry));
                }, 'btn-info');
            });
            return card;
        }

        async function updateSubscriptionStatus(subId, newStatus, newExpiryDate = null, newStartDate = null) {
            if (!userId || (auth.currentUser && auth.currentUser.email !== ALLOWED_EMAIL)) { 
                showInPageNotification("خطأ: لا يمكن تحديث الحالة. تأكد من تسجيل الدخول بحساب مصرح به.", 'error'); return; 
            }
            const subDocRef = doc(db, `artifacts/${dynamicAppId}/users/${userId}/subscriptions`, subId); 
            try {
                const updateData = { status: newStatus };
                if (newExpiryDate) updateData.expiryDate = newExpiryDate;
                if (newStartDate) updateData.startDate = newStartDate; 
                await updateDoc(subDocRef, updateData);
                showInPageNotification(`تم تحديث حالة الاشتراك بنجاح.`, 'success');
            } catch (error) { console.error("Error updating status:", error); showInPageNotification(`خطأ تحديث الحالة: ${error.message}`, 'error');}
        }

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => { btn.classList.remove('active-tab','text-indigo-600','border-indigo-600'); btn.classList.add('text-slate-500','hover:text-slate-700','hover:border-slate-400');});
                button.classList.add('active-tab','text-indigo-600','border-indigo-600');
                button.classList.remove('text-slate-500','hover:text-slate-700','hover:border-slate-400');
                currentVisibleTab = button.getAttribute('data-tab');
                tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `${currentVisibleTab}Subscriptions`));
                renderSubscriptions(); 
            });
        });
        
        exportCsvBtn.addEventListener('click', () => {
            const visibleSubs = allSubscriptions.filter(sub => sub.status === currentVisibleTab);
            if (visibleSubs.length === 0) { showInPageNotification(`لا توجد اشتراكات في تبويب "${currentVisibleTab}" للتصدير.`, 'warning'); return; }
            let csvContent = "\uFEFF"; 
            csvContent += "رقم الهاتف,تاريخ البدء,تاريخ الانتهاء,الحالة,ملاحظات\n";
            visibleSubs.forEach(sub => {
                const startDate = sub.startDate.toDate().toLocaleDateString('ar-EG');
                const expiryDate = sub.expiryDate.toDate().toLocaleDateString('ar-EG');
                const notes = (sub.notes || "").replace(/"/g, '""'); 
                csvContent += `"${sub.phoneNumber}","${startDate}","${expiryDate}","${sub.status}","${notes}"\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", 'data:text/csv;charset=utf-8,' + encodedUri);
            link.setAttribute("download", `subscriptions_${currentVisibleTab}_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link);
            showInPageNotification("تم تصدير البيانات بنجاح!", "success");
        });

    </script>
</body>
</html>