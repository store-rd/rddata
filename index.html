<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الاشتراكات المطور برو</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script id="firebase-config-data" type="application/json">
    {
        "apiKey": "AIzaSyCKGjIRLL0nZbuYRBkqNG7I0c1yf5SkwMk",
        "authDomain": "login-72424.firebaseapp.com",
        "projectId": "login-72424",
        "storageBucket": "login-72424.appspot.com",
        "messagingSenderId": "891002963088",
        "appId": "1:891002963088:web:d872167dbc464403528415",
        "measurementId": "G-CFLK1QXKDF" 
    }
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #eef2f7; color: #334155; }
        .main-container { max-width: 1300px; margin: auto; padding: 1rem; } /* Increased max-width slightly */
        @media (min-width: 640px) { .main-container { padding: 1.5rem; } }
        @media (min-width: 1024px) { .main-container { padding: 2rem; } }
        .header-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); transition: all 0.3s cubic-bezier(0.25,0.8,0.25,1); }
        .subscription-card { background-color: #ffffff; border-radius: 12px; border-right-width: 5px; position: relative; overflow: hidden; }
        .subscription-card:hover { transform: translateY(-6px) scale(1.01); box-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.15), 0 10px 15px -8px rgba(0, 0, 0, 0.1); }
        .subscription-card::before { content: ''; position: absolute; top: -50px; left: -50px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(102, 126, 234, 0.08) 0%, rgba(102, 126, 234, 0) 70%); opacity: 0.5; transition: opacity 0.3s ease; }
        .subscription-card:hover::before { opacity: 0.8; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; margin: 5% auto; padding: 30px; border: none; width: 90%; max-width: 580px; border-radius: 12px; box-shadow: 0 15px 30px rgba(0,0,0,0.2); transform: scale(0.95); opacity: 0; animation: modalAppear 0.3s ease-out forwards; }
        @keyframes modalAppear { to { transform: scale(1); opacity: 1; } }
        .tab-button { padding: 0.75rem 1.25rem; font-weight: 600; border-bottom-width: 3px; transition: all 0.2s ease-in-out; }
        .tab-button.active-tab { border-color: #4f46e5; color: #4f46e5; background-color: rgba(79, 70, 229, 0.05); }
        .tab-button:not(.active-tab):hover { background-color: rgba(100, 116, 139, 0.05); border-bottom-color: #cbd5e1; }
        .stat-badge { min-width: 26px; height: 26px; line-height: 26px; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        .loader { border: 4px solid #e0e7ff; border-top: 4px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; display: inline-block; margin-left: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input[type="tel"], input[type="text"], input[type="number"], input[type="date"], select, textarea { border-radius: 8px; border-color: #cbd5e1; padding: 0.85rem 1rem; transition: all 0.2s ease-in-out; background-color: #fff; }
        input[type="tel"]:focus, input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus, textarea:focus { border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }
        button { border-radius: 8px; padding-top: 0.75rem; padding-bottom: 0.75rem; font-weight: 600; transition: all 0.2s ease-in-out; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); }
        button:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.1); }
        .btn-primary { background-color: #4f46e5; color: white; } .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #e2e8f0; color: #334155; } .btn-secondary:hover { background-color: #cbd5e1; }
        .btn-danger { background-color: #dc2626; color: white; } .btn-danger:hover { background-color: #b91c1c; }
        .btn-success { background-color: #16a34a; color: white; } .btn-success:hover { background-color: #15803d; }
        .btn-info { background-color: #0ea5e9; color: white; } .btn-info:hover { background-color: #0284c7; }
        button i { margin-left: 0.5rem; margin-right: 0; } 
        #notificationArea > div { box-shadow: 0 10px 20px rgba(0,0,0,0.15); border-radius: 8px; font-size: 0.9rem; }
        #authContainer button.google-signin-btn { background-color: #db4437; color: white; padding-left: 1.5rem; padding-right: 1.5rem; }
        #authContainer button.google-signin-btn:hover { background-color: #c33d2e; }
        #userInfo { font-size: 0.8rem; padding: 0.5rem 1rem; background-color: rgba(255,255,255,0.1); border-radius: 8px; }
        #userInfo img { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; }
        .dashboard-stat-card { background-color: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .dashboard-stat-card h4 { font-size: 0.8rem; color: #64748b; margin-bottom: 0.25rem; }
        .dashboard-stat-card p { font-size: 1.6rem; line-height: 1.1; } /* Adjusted font size and line height */
        .critical-error-message { color: red; text-align: center; padding: 50px; font-size: 1.2em; background-color: #ffebee; border: 1px solid #e57373; border-radius: 8px; margin: 20px; }
    </style>
</head>
<body class="bg-slate-100 text-slate-700">

    <div id="confirmationModal" class="modal"> <div class="modal-content"> <h3 class="text-xl font-semibold mb-4 text-slate-800" id="confirmModalTitle">هل أنت متأكد؟</h3> <p id="modalMessage" class="text-slate-600 mb-6">سيتم تنفيذ هذا الإجراء.</p> <div class="flex justify-end gap-3"> <button id="cancelAction" class="btn-secondary px-5">إلغاء</button> <button id="confirmAction" class="btn-danger px-5">تأكيد</button> </div> </div> </div>
    <div id="editNoteModal" class="modal"> <div class="modal-content"> <h3 class="text-xl font-semibold mb-6 text-slate-800" id="editNoteModalTitle">تعديل المشترك</h3> <input type="hidden" id="editSubId"> 
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-5">
            <div><label for="editCustomerPhone" class="block text-sm font-medium text-slate-600 mb-1">رقم الهاتف:</label> <input type="tel" id="editCustomerPhone" class="w-full"> </div> 
            <div><label for="editSubscriptionPrice" class="block text-sm font-medium text-slate-600 mb-1">سعر الاشتراك:</label> <input type="number" id="editSubscriptionPrice" min="0" placeholder="0" class="w-full"></div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-5">
            <div> <label for="editStartDate" class="block text-sm font-medium text-slate-600 mb-1">تاريخ البدء:</label> <input type="date" id="editStartDate" class="w-full"> </div>
            <div> <label for="editExpiryDate" class="block text-sm font-medium text-slate-600 mb-1">تاريخ الانتهاء:</label> <input type="date" id="editExpiryDate" class="w-full"> </div>
        </div>
        <div class="mb-6"> <label for="editCustomerNotes" class="block text-sm font-medium text-slate-600 mb-1">ملاحظات:</label> <textarea id="editCustomerNotes" rows="3" class="w-full" placeholder="أضف ملاحظات هنا..."></textarea> </div> 
        <div class="flex justify-end gap-3"> <button id="cancelEditNote" class="btn-secondary px-5">إلغاء</button> <button id="saveEditNote" class="btn-primary px-5">حفظ التغييرات</button> </div> </div> </div>
    <div id="notificationArea" class="fixed top-5 left-5 z-[1001] w-full max-w-xs sm:max-w-sm p-4 sm:p-0"></div>

    <div class="main-container">
        <header class="text-center mb-10 py-6 sm:py-8 header-gradient text-white rounded-xl card-shadow">
            <div class="flex justify-center items-center mb-2">
                 <i class="fas fa-rocket fa-2x mr-3 transform -scale-x-100"></i>
                <h1 class="text-3xl sm:text-4xl font-bold">نظام إدارة الاشتراكات</h1>
            </div>
            <p class="opacity-80 mt-1 text-sm sm:text-base">إدارة شاملة لاشتراكات عملائك بكفاءة وفعالية.</p>
            <div id="authContainer" class="mt-4"></div>
        </header>

        <div id="mainContent" class="hidden"> 
            <div id="dashboardStats" class="mb-8 p-4 bg-white rounded-xl card-shadow grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-4">
                <div class="dashboard-stat-card"> <h4 >إجمالي النشطين</h4> <p id="totalActiveStat" class="font-bold text-green-600">0</p> </div>
                <div class="dashboard-stat-card"> <h4 >تنتهي خلال 7 أيام</h4> <p id="expiringSoonStat" class="font-bold text-yellow-600">0</p> </div>
                <div class="dashboard-stat-card"> <h4 >منتهية (تحتاج إجراء)</h4> <p id="expiredNeedsActionStat" class="font-bold text-red-600">0</p> </div>
                <div class="dashboard-stat-card"> <h4 >إجمالي المشتركين</h4> <p id="totalSubscribersStat" class="font-bold text-indigo-600">0</p> </div>
                <div class="dashboard-stat-card"> <h4 >إجمالي الربح (نشط)</h4> <p id="totalProfitStat" class="font-bold text-purple-600">0</p> </div>
            </div>

            <div class="mb-10 p-6 sm:p-8 bg-white rounded-xl card-shadow">
                <h2 class="text-2xl font-semibold mb-6 text-indigo-700 flex items-center"> <i class="fas fa-user-plus mr-3 text-xl"></i>إدارة المشتركين </h2>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-5 items-end">
                    <div class="md:col-span-2"> <label for="customerPhone" class="block text-sm font-medium text-slate-600 mb-1">رقم هاتف العميل:</label> <input type="tel" id="customerPhone" placeholder="مثال: 07701234567" class="w-full" /> </div>
                    <div> <label for="subscriptionPrice" class="block text-sm font-medium text-slate-600 mb-1">سعر الاشتراك:</label> <input type="number" id="subscriptionPrice" min="0" placeholder="0" class="w-full" /> </div>
                    <div> <label for="subscriptionDuration" class="block text-sm font-medium text-slate-600 mb-1">مدة الاشتراك (أيام):</label> <input type="number" id="subscriptionDuration" value="30" min="1" class="w-full" /> </div>
                    <div> <button id="addSubscriberBtn" class="btn-primary w-full py-3 px-6 flex items-center justify-center"> <i class="fas fa-plus-circle"></i>إضافة مشترك <span id="addSubscriberLoader" class="loader hidden"></span> </button> </div>
                </div>
                 <div class="mt-8"> <label for="searchInput" class="block text-sm font-medium text-slate-600 mb-1"> <i class="fas fa-search mr-2 opacity-70"></i>بحث (هاتف أو ملاحظات): </label> <input type="text" id="searchInput" placeholder="أدخل جزء من الرقم أو الملاحظات للبحث..." class="w-full"> </div>
            </div>
            
            <div class="mb-8 flex flex-col sm:flex-row justify-between items-center gap-4 p-5 bg-white rounded-xl card-shadow">
                <div> <label for="sortOptions" class="text-sm font-medium text-slate-600 mr-2"><i class="fas fa-sort-amount-down mr-1 opacity-70"></i>فرز حسب:</label> <select id="sortOptions" class="text-sm"> <option value="expiryDateAsc">تاريخ الانتهاء (الأقرب أولاً)</option> <option value="expiryDateDesc">تاريخ الانتهاء (الأبعد أولاً)</option> <option value="createdAtDesc">تاريخ الإضافة (الأحدث أولاً)</option> <option value="createdAtAsc">تاريخ الإضافة (الأقدم أولاً)</option> <option value="priceDesc">السعر (الأعلى أولاً)</option> <option value="priceAsc">السعر (الأقل أولاً)</option> </select> </div>
                <button id="exportCsvBtn" class="btn-success py-2 px-5 text-sm"> <i class="fas fa-file-csv"></i>تصدير المحدد (CSV) </button>
            </div>

            <div class="mb-6">
                <nav class="flex flex-wrap -mb-px border-b border-slate-300" aria-label="Tabs">
                    <button data-tab="active" class="tab-button active-tab"> <i class="fas fa-stream mr-2"></i>النشطة <span id="activeCount" class="bg-green-500 text-white text-xs font-semibold mr-1 px-2 py-0.5 rounded-full stat-badge">0</span> </button>
                    <button data-tab="expired" class="tab-button text-slate-500"> <i class="fas fa-hourglass-half mr-2"></i>المنتهية <span id="expiredCount" class="bg-red-500 text-white text-xs font-semibold mr-1 px-2 py-0.5 rounded-full stat-badge">0</span> </button>
                    <button data-tab="removed" class="tab-button text-slate-500"> <i class="fas fa-trash-alt mr-2"></i>المزالة <span id="removedCount" class="bg-slate-400 text-white text-xs font-semibold mr-1 px-2 py-0.5 rounded-full stat-badge">0</span> </button>
                </nav>
            </div>

            <div id="subscriptionsContainer" class="min-h-[250px] pb-10">
                <div id="activeSubscriptions" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 sm:gap-6 tab-content"></div>
                <div id="expiredSubscriptions" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 sm:gap-6 tab-content hidden"></div>
                <div id="removedSubscriptions" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 sm:gap-6 tab-content hidden"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, serverTimestamp, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const NOTIFY_NEW_SUBSCRIBER_FUNCTION_URL = "https://notifynewsubscriber-3mkobbduaa-uc.a.run.app"; 
        const ALLOWED_EMAIL = "soso.lovr66@gmail.com"; 
        const DEFAULT_SUBSCRIPTION_DAYS = 30;
        const CURRENCY_SYMBOL = "د.ع"; // رمز العملة (مثال: دولار أمريكي $, دينار عراقي د.ع)

        setLogLevel('info'); 

        function getFirebaseConfig() {
            let config;
            if (typeof window.__firebase_config === 'string') { try { config = JSON.parse(window.__firebase_config); console.log("Using Firebase Hosting injected configuration (from string)."); } catch (e) { console.warn("Failed to parse __firebase_config string, trying as object.", e);}}
            if (!config && typeof window.__firebase_config === 'object' && window.__firebase_config !== null) { config = window.__firebase_config; console.log("Using Firebase Hosting injected configuration (from object).");}
            if (!config) { const configElement = document.getElementById('firebase-config-data'); if (configElement && configElement.textContent) { try { config = JSON.parse(configElement.textContent); console.log("Using embedded JSON configuration."); } catch (e) { console.error("Error parsing embedded Firebase config JSON:", e); }}}
            return config;
        }

        const firebaseConfig = getFirebaseConfig();
        let app, auth, db, googleProvider, dynamicAppId;

        if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes("YOUR_API_KEY_HERE")) {
            console.error("Firebase configuration is missing, invalid, or uses placeholder values. App cannot start.");
            const mainContainer = document.querySelector('.main-container');
            if (mainContainer) mainContainer.innerHTML = '<div class="critical-error-message">خطأ حرج: تهيئة Firebase غير موجودة أو غير صالحة أو تستخدم قيماً مؤقتة. <br>يرجى التأكد من تعبئة إعدادات Firebase الصحيحة في المكان المخصص في الكود. لا يمكن بدء تشغيل التطبيق.</div>';
        } else {
            app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); googleProvider = new GoogleAuthProvider(); dynamicAppId = firebaseConfig.appId || 'default-app-id'; 
        }

        let userId = null, allSubscriptions = [], currentSortOption = 'expiryDateAsc', currentFilterQuery = '', currentVisibleTab = 'active';

        const authContainer = document.getElementById('authContainer');
        const mainContentDiv = document.getElementById('mainContent');
        const customerPhoneInput = document.getElementById('customerPhone');
        const subscriptionPriceInput = document.getElementById('subscriptionPrice');
        const subscriptionDurationInput = document.getElementById('subscriptionDuration');
        const addSubscriberBtn = document.getElementById('addSubscriberBtn');
        const addSubscriberLoader = document.getElementById('addSubscriberLoader');
        const searchInput = document.getElementById('searchInput');
        const sortOptionsSelect = document.getElementById('sortOptions');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const activeSubscriptionsDiv = document.getElementById('activeSubscriptions'), expiredSubscriptionsDiv = document.getElementById('expiredSubscriptions'), removedSubscriptionsDiv = document.getElementById('removedSubscriptions');
        const activeCountSpan = document.getElementById('activeCount'), expiredCountSpan = document.getElementById('expiredCount'), removedCountSpan = document.getElementById('removedCount');
        const totalActiveStat = document.getElementById('totalActiveStat'), expiringSoonStat = document.getElementById('expiringSoonStat'), expiredNeedsActionStat = document.getElementById('expiredNeedsActionStat'), totalSubscribersStat = document.getElementById('totalSubscribersStat'), totalProfitStat = document.getElementById('totalProfitStat');
        const confirmationModal = document.getElementById('confirmationModal'), confirmModalTitle = document.getElementById('confirmModalTitle'), modalMessage = document.getElementById('modalMessage'), confirmActionBtn = document.getElementById('confirmAction'), cancelActionBtn = document.getElementById('cancelAction');
        let currentConfirmActionCallback = null;
        const editNoteModal = document.getElementById('editNoteModal'), editNoteModalTitle = document.getElementById('editNoteModalTitle'), editSubIdInput = document.getElementById('editSubId'), editCustomerPhoneInput = document.getElementById('editCustomerPhone'), editSubscriptionPriceInput = document.getElementById('editSubscriptionPrice'), editStartDateInput = document.getElementById('editStartDate'), editExpiryDateInput = document.getElementById('editExpiryDate'), editCustomerNotesTextarea = document.getElementById('editCustomerNotes'), saveEditNoteBtn = document.getElementById('saveEditNote'), cancelEditNoteBtn = document.getElementById('cancelEditNote');

        function formatPrice(price) { return `${price.toLocaleString()} ${CURRENCY_SYMBOL}`; }
        function formatDateForInput(date) { if (!date) return ''; const d = (date instanceof Date) ? date : date.toDate(); const year = d.getFullYear(), month = ('0' + (d.getMonth() + 1)).slice(-2), day = ('0' + d.getDate()).slice(-2); return `${year}-${month}-${day}`; }
        function parseDateFromInput(dateString) { if (!dateString) return null; const parts = dateString.split('-'); return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));}
        
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    if (user.email === ALLOWED_EMAIL) {
                        userId = user.uid; console.log("Allowed user signed in:", user.displayName, user.email, user.uid);
                        authContainer.innerHTML = `<div id="userInfo" class="flex items-center justify-center text-white">${user.photoURL ? `<img src="${user.photoURL}" alt="Profile Picture" class="w-6 h-6 rounded-full mr-2">` : '<i class="fas fa-user-circle fa-lg mr-2"></i>'}<span class="mr-2">${user.displayName || user.email}</span><button id="signOutBtn" class="btn-secondary text-xs py-1 px-3 bg-white/20 hover:bg-white/30">تسجيل الخروج</button></div><p class="text-xs opacity-70 mt-1">معرف المستخدم: <span class="font-mono">${userId}</span></p>`;
                        document.getElementById('signOutBtn').addEventListener('click', async () => { try { await signOut(auth); } catch (error) { console.error("Error signing out:", error); showInPageNotification("خطأ أثناء تسجيل الخروج.", "error");}});
                        mainContentDiv.classList.remove('hidden'); loadAndListenSubscriptions();
                    } else {
                        console.warn("Unauthorized user attempted sign-in:", user.email);
                        authContainer.innerHTML = `<p class="text-red-200 text-sm p-2 bg-red-700/50 rounded-md">عذرًا، البريد الإلكتروني (${user.email}) غير مصرح له باستخدام هذا النظام.</p><button id="signOutBtnUnauthorized" class="btn-secondary text-xs py-1 px-3 mt-2 bg-white/20 hover:bg-white/30">تسجيل الخروج</button>`;
                        if(document.getElementById('signOutBtnUnauthorized')) { document.getElementById('signOutBtnUnauthorized').addEventListener('click', async () => { await signOut(auth); });}
                        mainContentDiv.classList.add('hidden'); allSubscriptions = []; renderSubscriptions(); userId = null; 
                    }
                } else {
                    userId = null; console.log("User is signed out.");
                    authContainer.innerHTML = `<button id="signInBtn" class="google-signin-btn py-2 px-6"><i class="fab fa-google mr-2"></i> تسجيل الدخول باستخدام جوجل</button>`;
                    document.getElementById('signInBtn').addEventListener('click', async () => { try { await signInWithPopup(auth, googleProvider); } catch (error) { console.error("Error during Google sign-in:", error); let msg = "فشل تسجيل الدخول."; if (error.code === 'auth/popup-closed-by-user') msg = "تم إغلاق نافذة تسجيل الدخول."; else if (error.code === 'auth/cancelled-popup-request') return; showInPageNotification(msg, "error");}});
                    mainContentDiv.classList.add('hidden'); allSubscriptions = []; renderSubscriptions(); 
                }
            });
        } else { authContainer.innerHTML = `<p class="text-red-200 text-sm p-2 bg-red-700/50 rounded-md">خطأ في تهيئة Firebase. لا يمكن تسجيل الدخول.</p>`; }
        
        function showInPageNotification(message, type = 'info', duration = 4500) {
            const area = document.getElementById('notificationArea'); if (!area) return; 
            const notificationDiv = document.createElement('div'); notificationDiv.className = `p-4 mb-3 rounded-lg shadow-xl text-white text-sm transform transition-all duration-300 ease-out opacity-0 translate-x-full`;
            if (type === 'error') notificationDiv.classList.add('bg-red-500'); else if (type === 'success') notificationDiv.classList.add('bg-green-500'); else if (type === 'warning') notificationDiv.classList.add('bg-yellow-500', 'text-yellow-800'); else notificationDiv.classList.add('bg-indigo-500');
            const contentWrapper = document.createElement('div'); contentWrapper.className = 'flex items-center';
            const iconSpan = document.createElement('span'); iconSpan.className = 'ml-2'; 
            let iconClass = 'fas fa-info-circle'; if (type === 'error') iconClass = 'fas fa-times-circle'; else if (type === 'success') iconClass = 'fas fa-check-circle'; else if (type === 'warning') iconClass = 'fas fa-exclamation-triangle'; iconSpan.innerHTML = `<i class="${iconClass} text-lg"></i>`;
            const msgSpan = document.createElement('span'); msgSpan.textContent = message; msgSpan.className = 'flex-grow';
            const closeBtn = document.createElement('button'); closeBtn.innerHTML = '<i class="fas fa-times"></i>'; closeBtn.className = 'mr-auto text-lg leading-none hover:text-white/70 transition-colors focus:outline-none';
            closeBtn.onclick = () => { notificationDiv.classList.replace('opacity-100', 'opacity-0'); notificationDiv.classList.replace('translate-x-0', 'translate-x-full'); setTimeout(() => notificationDiv.remove(), 300); };
            contentWrapper.appendChild(iconSpan); contentWrapper.appendChild(msgSpan); contentWrapper.appendChild(closeBtn); notificationDiv.appendChild(contentWrapper);
            area.appendChild(notificationDiv); setTimeout(() => { notificationDiv.classList.replace('opacity-0', 'opacity-100'); notificationDiv.classList.replace('translate-x-full', 'translate-x-0'); }, 50);
            setTimeout(() => { if (document.body.contains(notificationDiv)) closeBtn.click(); }, duration);
        }
        
        if (addSubscriberBtn) addSubscriberBtn.addEventListener('click', async () => {
            if (!db) { showInPageNotification("خطأ: قاعدة البيانات غير مهيأة.", "error"); return; }
            const phoneNumber = customerPhoneInput.value.trim();
            const price = parseFloat(subscriptionPriceInput.value) || 0;
            const durationDays = parseInt(subscriptionDurationInput.value) || DEFAULT_SUBSCRIPTION_DAYS;

            if (!phoneNumber || !/^\d{10,15}$/.test(phoneNumber)) { showInPageNotification("الرجاء إدخال رقم هاتف صحيح.", 'error'); return; }
            if (price < 0) { showInPageNotification("سعر الاشتراك يجب أن يكون رقمًا موجبًا أو صفر.", 'error'); return; }
            if (durationDays <= 0) { showInPageNotification("الرجاء إدخال مدة اشتراك صحيحة.", 'error'); return; }
            if (!userId || (auth.currentUser && auth.currentUser.email !== ALLOWED_EMAIL)) { showInPageNotification("خطأ: يجب تسجيل الدخول بحساب مصرح به.", 'error'); return; }

            addSubscriberBtn.disabled = true; addSubscriberLoader.classList.remove('hidden'); const originalButtonText = addSubscriberBtn.querySelector('i').nextSibling.textContent.trim(); addSubscriberBtn.childNodes[1].textContent = ' جارٍ الإضافة... ';
            const startDate = new Date(), expiryDate = new Date(); expiryDate.setDate(startDate.getDate() + durationDays);

            try {
                await addDoc(collection(db, `artifacts/${dynamicAppId}/users/${userId}/subscriptions`), {
                    phoneNumber, price, startDate: Timestamp.fromDate(startDate), expiryDate: Timestamp.fromDate(expiryDate),
                    subscriptionDurationDays: durationDays, status: "active", notes: "", 
                    createdAt: serverTimestamp(), updatedAt: serverTimestamp(), lastRenewedAt: null
                });
                customerPhoneInput.value = ''; subscriptionPriceInput.value = ''; subscriptionDurationInput.value = DEFAULT_SUBSCRIPTION_DAYS;
                showInPageNotification("تمت إضافة المشترك بنجاح!", 'success');
                if (NOTIFY_NEW_SUBSCRIBER_FUNCTION_URL && NOTIFY_NEW_SUBSCRIBER_FUNCTION_URL.startsWith("https://")) {
                    fetch(NOTIFY_NEW_SUBSCRIBER_FUNCTION_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ phoneNumber, price, startDate: startDate.toISOString(), expiryDate: expiryDate.toISOString(), duration: durationDays }),
                    }).then(async response => { if (response.ok) { const result = await response.json(); if (result.success) showInPageNotification("تم إرسال إشعار الإضافة.", 'info'); else showInPageNotification("فشل إرسال إشعار: " + (result.message || "خطأ"), 'error'); } else { const errorText = await response.text(); showInPageNotification(`خطأ استدعاء دالة الإشعار: ${response.status} ${errorText}`, 'error', 7000); }
                    }).catch(teleError => { console.error("Error calling notifyNewSubscriber function:", teleError); showInPageNotification(`فشل الاتصال بدالة الإشعار: ${teleError.message}`, 'error', 7000);});
                } else if (NOTIFY_NEW_SUBSCRIBER_FUNCTION_URL !== "YOUR_NOTIFY_NEW_SUBSCRIBER_FUNCTION_URL_HERE") { showInPageNotification("تنبيه: رابط دالة إشعار تليجرام غير مكون.", "warning", 6000); }
            } catch (error) {
                console.error("Error adding subscriber: ", error);
                if (error.code === 'permission-denied' || (error.message && error.message.toLowerCase().includes('permission-denied'))) { showInPageNotification(`خطأ إضافة: أذونات غير كافية. راجع قواعد الأمان.`, 'error', 10000);
                } else { showInPageNotification(`خطأ إضافة مشترك: ${error.message}`, 'error'); }
            } finally { addSubscriberBtn.disabled = false; addSubscriberLoader.classList.add('hidden'); addSubscriberBtn.childNodes[1].textContent = ` ${originalButtonText} `; }
        });

        function showConfirmationModal(title, message, actionCallback, confirmButtonClass = 'btn-danger') { confirmModalTitle.textContent = title; modalMessage.innerHTML = message; confirmActionBtn.className = `btn-${confirmButtonClass.replace('btn-','')} px-5`; confirmationModal.style.display = 'flex'; currentConfirmActionCallback = actionCallback; }
        if (confirmActionBtn) confirmActionBtn.onclick = () => { if (currentConfirmActionCallback) currentConfirmActionCallback(); closeConfirmationModal(); };
        if (cancelActionBtn) cancelActionBtn.onclick = closeConfirmationModal;
        function closeConfirmationModal() { if (confirmationModal) confirmationModal.style.display = 'none'; currentConfirmActionCallback = null; }

        function openEditNoteModal(sub) {
            editNoteModalTitle.textContent = `تعديل بيانات: ${sub.phoneNumber}`; editSubIdInput.value = sub.id;
            editCustomerPhoneInput.value = sub.phoneNumber; editSubscriptionPriceInput.value = sub.price || 0;
            editStartDateInput.value = formatDateForInput(sub.startDate); editExpiryDateInput.value = formatDateForInput(sub.expiryDate);
            editCustomerNotesTextarea.value = sub.notes || ''; editNoteModal.style.display = 'flex';
        }
        if (saveEditNoteBtn) saveEditNoteBtn.onclick = async () => {
            if (!db) { showInPageNotification("خطأ: قاعدة البيانات غير مهيأة.", "error"); return; }
            const subId = editSubIdInput.value, newPhoneNumber = editCustomerPhoneInput.value.trim(), newPrice = parseFloat(editSubscriptionPriceInput.value) || 0;
            const newNotes = editCustomerNotesTextarea.value.trim(), newStartDateStr = editStartDateInput.value, newExpiryDateStr = editExpiryDateInput.value;

            if (!newPhoneNumber || !/^\d{10,15}$/.test(newPhoneNumber)) { showInPageNotification("الرجاء إدخال رقم هاتف صحيح.", 'error'); return; }
            if (newPrice < 0) { showInPageNotification("سعر الاشتراك يجب أن يكون رقمًا موجبًا أو صفر.", 'error'); return; }
            if (!newStartDateStr || !newExpiryDateStr) { showInPageNotification("الرجاء إدخال تاريخي البدء والانتهاء.", 'error'); return; }
            const newStartDate = parseDateFromInput(newStartDateStr), newExpiryDate = parseDateFromInput(newExpiryDateStr);
            if (!newStartDate || !newExpiryDate || newStartDate >= newExpiryDate) { showInPageNotification("تاريخ الانتهاء يجب أن يكون بعد تاريخ البدء.", "error"); return; }
            if (!userId || !subId || (auth.currentUser && auth.currentUser.email !== ALLOWED_EMAIL)) { showInPageNotification("خطأ: لا يمكن حفظ التغييرات. تأكد من تسجيل الدخول.", 'error'); return; }
            
            const subDocRef = doc(db, `artifacts/${dynamicAppId}/users/${userId}/subscriptions`, subId);
            const durationDays = Math.round((newExpiryDate.getTime() - newStartDate.getTime()) / (1000 * 60 * 60 * 24));
            try {
                await updateDoc(subDocRef, { phoneNumber: newPhoneNumber, price: newPrice, notes: newNotes, startDate: Timestamp.fromDate(newStartDate), expiryDate: Timestamp.fromDate(newExpiryDate), subscriptionDurationDays: durationDays, updatedAt: serverTimestamp() });
                showInPageNotification("تم حفظ التغييرات بنجاح!", 'success'); closeEditNoteModal();
            } catch (error) { console.error("Error updating details:", error); showInPageNotification(`خطأ تحديث البيانات: ${error.message}`, 'error');}
        };
        if (cancelEditNoteBtn) cancelEditNoteBtn.onclick = closeEditNoteModal;
        function closeEditNoteModal() { if (editNoteModal) editNoteModal.style.display = 'none'; }
        window.onclick = (event) => { if (event.target == confirmationModal) closeConfirmationModal(); if (event.target == editNoteModal) closeEditNoteModal(); };
        
        if (searchInput) searchInput.addEventListener('input', (e) => { currentFilterQuery = e.target.value.toLowerCase(); renderSubscriptions(); });
        if (sortOptionsSelect) sortOptionsSelect.addEventListener('change', (e) => { currentSortOption = e.target.value; renderSubscriptions(); });
        
        function loadAndListenSubscriptions() {
            if (!userId || !db) { allSubscriptions = []; renderSubscriptions(); return; }
            const path = `artifacts/${dynamicAppId}/users/${userId}/subscriptions`; 
            const q = query(collection(db, path));
            onSnapshot(q, async (querySnapshot) => {
                const now = new Date(); const subsToUpdateStatus = [];
                allSubscriptions = querySnapshot.docs.map(docSnapshot => {
                    const sub = { id: docSnapshot.id, ...docSnapshot.data() };
                    ['startDate', 'expiryDate', 'createdAt', 'updatedAt', 'lastRenewedAt'].forEach(field => {
                        if (sub[field] && typeof sub[field].toDate === 'function') sub[field] = sub[field].toDate();
                    });
                    if (sub.status === "active" && sub.expiryDate < now) { subsToUpdateStatus.push({ id: sub.id, newStatus: "expired" }); sub.status = "expired"; }
                    return sub;
                });
                if (subsToUpdateStatus.length > 0) {
                    const batch = writeBatch(db); subsToUpdateStatus.forEach(s => batch.update(doc(db, path, s.id), { status: s.newStatus, updatedAt: serverTimestamp() }));
                    try { await batch.commit(); console.log("Batch status update successful."); } catch (err) { console.error("Error batch updating statuses:", err); }
                }
                renderSubscriptions();
            }, (error) => { console.error("Error fetching subscriptions:", error); showInPageNotification(`خطأ جلب الاشتراكات: ${error.message}`, 'error'); });
        }

        function renderSubscriptions() {
            if (!activeSubscriptionsDiv) return; 
            let filteredSubs = [...allSubscriptions];
            if (currentFilterQuery) {
                filteredSubs = filteredSubs.filter(sub => 
                    sub.phoneNumber.includes(currentFilterQuery) || 
                    (sub.notes && sub.notes.toLowerCase().includes(currentFilterQuery))
                );
            }
            filteredSubs.sort((a, b) => {
                const dateA = a.expiryDate, dateB = b.expiryDate;
                const createdA = a.createdAt || new Date(0), createdB = b.createdAt || new Date(0);
                const priceA = a.price || 0, priceB = b.price || 0;
                switch (currentSortOption) {
                    case 'expiryDateDesc': return dateB - dateA;
                    case 'createdAtAsc': return createdA - createdB;
                    case 'createdAtDesc': return createdB - createdA;
                    case 'priceDesc': return priceB - priceA;
                    case 'priceAsc': return priceA - priceB;
                    default: return dateA - dateB; 
                }
            });
            
            [activeSubscriptionsDiv, expiredSubscriptionsDiv, removedSubscriptionsDiv].forEach(div => div.innerHTML = '');
            let activeC = 0, expiredC = 0, removedC = 0, expiringSoonC = 0;
            let currentTotalProfit = 0;
            const now = new Date(), sevenDaysFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            const placeholderText = (text) => `<div class="col-span-full text-center text-slate-500 py-10"><i class="fas fa-info-circle fa-2x mb-3 text-slate-400"></i><p>${text}</p></div>`;

            if (!userId || (auth && auth.currentUser && auth.currentUser.email !== ALLOWED_EMAIL) ) { 
                const authMessage = auth && auth.currentUser && auth.currentUser.email !== ALLOWED_EMAIL ? `البريد (${auth.currentUser.email}) غير مصرح له.` : 'يرجى تسجيل الدخول.';
                [activeSubscriptionsDiv, expiredSubscriptionsDiv, removedSubscriptionsDiv].forEach(div => div.innerHTML = placeholderText(authMessage));
                activeCountSpan.textContent = 0; expiredCountSpan.textContent = 0; removedCountSpan.textContent = 0;
                updateDashboardStats(0,0,0,0,0); return;
            }

            if (filteredSubs.length === 0 && allSubscriptions.length > 0 && currentFilterQuery) {
                 [activeSubscriptionsDiv, expiredSubscriptionsDiv, removedSubscriptionsDiv].forEach(div => { if (div.id === `${currentVisibleTab}Subscriptions`) div.innerHTML = placeholderText('لا توجد نتائج بحث مطابقة.'); });
            } else if (allSubscriptions.length === 0 && userId) { 
                 [activeSubscriptionsDiv, expiredSubscriptionsDiv, removedSubscriptionsDiv].forEach(div => div.innerHTML = placeholderText('لا توجد اشتراكات. ابدأ بإضافة مشترك جديد!'));
            }

            allSubscriptions.forEach(sub => { // Calculate total profit from ALL active subs, regardless of filter
                if (sub.status === "active") currentTotalProfit += (sub.price || 0);
            });

            filteredSubs.forEach(sub => {
                const card = createSubscriptionCard(sub);
                if (sub.status === "active") { activeSubscriptionsDiv.appendChild(card); activeC++; if (sub.expiryDate < sevenDaysFromNow) expiringSoonC++; }
                else if (sub.status === "expired") { expiredSubscriptionsDiv.appendChild(card); expiredC++; }
                else if (sub.status === "removed") { removedSubscriptionsDiv.appendChild(card); removedC++; }
            });
            
            activeCountSpan.textContent = activeC; expiredCountSpan.textContent = expiredC; removedCountSpan.textContent = removedC;
            updateDashboardStats(activeC, expiringSoonC, expiredC, allSubscriptions.filter(s => s.status !== 'removed').length, currentTotalProfit);

            if (userId) { 
                if (activeC === 0 && (currentVisibleTab === 'active' || !currentFilterQuery) && (allSubscriptions.length > 0 || filteredSubs.length > 0) ) activeSubscriptionsDiv.innerHTML = activeSubscriptionsDiv.innerHTML || placeholderText('لا توجد اشتراكات نشطة حالياً.');
                if (expiredC === 0 && (currentVisibleTab === 'expired' || !currentFilterQuery) && (allSubscriptions.length > 0 || filteredSubs.length > 0)) expiredSubscriptionsDiv.innerHTML = expiredSubscriptionsDiv.innerHTML || placeholderText('لا توجد اشتراكات منتهية حالياً.');
                if (removedC === 0 && (currentVisibleTab === 'removed' || !currentFilterQuery) && (allSubscriptions.length > 0 || filteredSubs.length > 0)) removedSubscriptionsDiv.innerHTML = removedSubscriptionsDiv.innerHTML || placeholderText('لا توجد اشتراكات تمت إزالتها.');
            }
        }

        function updateDashboardStats(active, expiringSoon, expired, totalSubs, profit) {
            if (totalActiveStat) totalActiveStat.textContent = active;
            if (expiringSoonStat) expiringSoonStat.textContent = expiringSoon;
            if (expiredNeedsActionStat) expiredNeedsActionStat.textContent = expired;
            if (totalSubscribersStat) totalSubscribersStat.textContent = totalSubs; 
            if (totalProfitStat) totalProfitStat.textContent = formatPrice(profit);
        }

        function createSubscriptionCard(subscription) {
            const card = document.createElement('div'); card.className = 'subscription-card p-5 sm:p-6 card-shadow flex flex-col justify-between min-h-[280px]'; 
            const expiryDate = subscription.expiryDate, startDate = subscription.startDate;   
            const now = new Date(); const daysRemaining = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
            let statusText = "", statusColorClass = "", iconClass = "", textColorClass = "";

            if (subscription.status === "active") {
                if (daysRemaining > 7) { statusText = `نشط - متبقي ${daysRemaining} يوم`; statusColorClass = 'border-green-500'; iconClass = 'fas fa-check-circle text-green-500'; textColorClass = 'text-green-600';}
                else if (daysRemaining > 0) { statusText = `نشط - سينتهي خلال ${daysRemaining} يوم!`; statusColorClass = 'border-yellow-500'; iconClass = 'fas fa-exclamation-triangle text-yellow-500'; textColorClass = 'text-yellow-600';}
                else { statusText = "منتهي (راجع الحالة)"; statusColorClass = 'border-red-500'; iconClass = 'fas fa-times-circle text-red-500'; textColorClass = 'text-red-600';}
            } else if (subscription.status === "expired") { statusText = "منتهي - يتطلب إجراء"; statusColorClass = 'border-red-500'; iconClass = 'fas fa-hourglass-end text-red-500'; textColorClass = 'text-red-600';
            } else if (subscription.status === "removed") { statusText = "تمت الإزالة"; statusColorClass = 'border-slate-400'; iconClass = 'fas fa-user-slash text-slate-500'; textColorClass = 'text-slate-500'; }
            card.classList.add(statusColorClass);

            const dateOptions = { day: '2-digit', month: 'short', year: 'numeric' };
            const createdAtDate = subscription.createdAt ? subscription.createdAt.toLocaleDateString('ar-EG', dateOptions) : 'غير متاح';
            const lastRenewedDate = subscription.lastRenewedAt ? subscription.lastRenewedAt.toLocaleDateString('ar-EG', dateOptions) : '';
            const durationDisplay = subscription.subscriptionDurationDays ? `<p class="text-xs text-slate-500">المدة: ${subscription.subscriptionDurationDays} يوم</p>` : '';
            const lastRenewedDisplay = lastRenewedDate ? `<p class="text-xs text-slate-500">آخر تجديد: ${lastRenewedDate}</p>` : '';
            const priceDisplay = subscription.price > 0 ? `<p class="text-sm font-semibold text-purple-600 mt-1.5">السعر: ${formatPrice(subscription.price)}</p>` : `<p class="text-sm text-slate-500 mt-1.5">السعر: لم يحدد</p>`;

            card.innerHTML = `
                <div>
                    <div class="flex items-center mb-2 justify-between">
                        <div class="flex items-center"> <i class="${iconClass} ml-2 text-xl"></i> <h3 class="text-xl font-bold text-indigo-700 truncate" title="${subscription.phoneNumber}">${subscription.phoneNumber}</h3> </div>
                    </div>
                    ${priceDisplay}
                    <p class="text-xs text-slate-500 mb-0.5 mt-1">تاريخ البدء: ${startDate.toLocaleDateString('ar-EG', dateOptions)}</p>
                    <p class="text-xs text-slate-600 font-medium">تاريخ الانتهاء: ${expiryDate.toLocaleDateString('ar-EG', dateOptions)}</p>
                    <p class="text-sm font-semibold mt-2 ${textColorClass}">${statusText}</p>
                    <div class="text-xs text-slate-500 mt-1.5 space-y-0.5"> ${durationDisplay} <p>تاريخ الإنشاء: ${createdAtDate}</p> ${lastRenewedDisplay} </div>
                    ${subscription.notes ? `<p class="text-xs text-slate-500 mt-2.5 bg-slate-100 p-2 rounded-md break-words max-h-20 overflow-y-auto"><i class="fas fa-sticky-note ml-1 text-slate-400"></i>${subscription.notes}</p>` : ''}
                </div>
                <div class="mt-4 pt-4 border-t border-slate-200 flex flex-wrap gap-2 justify-end items-center">
                    <button data-id="${subscription.id}" class="edit-btn text-xs text-indigo-600 hover:text-indigo-800 py-1 px-2 rounded-md hover:bg-indigo-50 transition" title="تعديل"><i class="fas fa-edit fa-fw"></i> تعديل</button>
                    ${subscription.status !== "removed" ? `<button data-id="${subscription.id}" class="mark-removed-btn btn-danger text-xs py-1 px-2"><i class="fas fa-user-slash fa-fw ml-1"></i>إزالة</button>` : ''}
                    ${subscription.status === "removed" ? `<button data-id="${subscription.id}" class="reactivate-btn btn-success text-xs py-1 px-2"><i class="fas fa-check-circle fa-fw ml-1"></i>إعادة تفعيل</button>` : ''}
                    ${subscription.status === "expired" || subscription.status === "active" ? `<button data-id="${subscription.id}" data-current-expiry="${expiryDate.toISOString()}" class="renew-btn btn-info text-xs py-1 px-2"><i class="fas fa-history fa-fw ml-1"></i>تجديد</button>` : ''}
                </div>
            `;
            card.querySelector('.edit-btn').addEventListener('click', () => openEditNoteModal(subscription));
            const markRemovedBtn = card.querySelector('.mark-removed-btn');
            if (markRemovedBtn) markRemovedBtn.addEventListener('click', () => showConfirmationModal('تأكيد الإزالة', `هل تريد إزالة ${subscription.phoneNumber}؟`, () => updateSubscriptionStatus(subscription.id, "removed"), 'btn-danger'));
            
            const reactivateBtn = card.querySelector('.reactivate-btn');
            if (reactivateBtn) reactivateBtn.addEventListener('click', () => {
                const duration = subscription.subscriptionDurationDays || DEFAULT_SUBSCRIPTION_DAYS;
                showConfirmationModal('إعادة تفعيل الاشتراك', `إعادة تفعيل ${subscription.phoneNumber}؟<br>اشتراك جديد لمدة <b>${duration} يوم</b> من تاريخ اليوم. السعر الحالي ${formatPrice(subscription.price || 0)} سيتم الاحتفاظ به.`, () => {
                    const newStartDate = new Date(), newExpiry = new Date(newStartDate); newExpiry.setDate(newStartDate.getDate() + duration);
                    updateSubscriptionStatus(subscription.id, "active", Timestamp.fromDate(newExpiry), Timestamp.fromDate(newStartDate), duration, true, subscription.price || 0);
                }, 'btn-success');
            });

            const renewBtn = card.querySelector('.renew-btn');
            if (renewBtn) renewBtn.addEventListener('click', () => {
                const currentExpiry = new Date(renewBtn.dataset.currentExpiry); const durationToRenew = subscription.subscriptionDurationDays || DEFAULT_SUBSCRIPTION_DAYS;
                const newStartDateForRenewal = new Date(Math.max(now, currentExpiry)); const newExpiry = new Date(newStartDateForRenewal); newExpiry.setDate(newStartDateForRenewal.getDate() + durationToRenew);
                showConfirmationModal('تجديد الاشتراك', `تجديد اشتراك ${subscription.phoneNumber} لمدة <b>${durationToRenew} يوم</b> إضافية؟<br> سينتهي في ${newExpiry.toLocaleDateString('ar-EG', dateOptions)}. السعر الحالي ${formatPrice(subscription.price || 0)} سيتم الاحتفاظ به.`, () => {
                    updateSubscriptionStatus(subscription.id, "active", Timestamp.fromDate(newExpiry), null, durationToRenew, true, subscription.price || 0);
                }, 'btn-info');
            });
            return card;
        }

        async function updateSubscriptionStatus(subId, newStatus, newExpiryDate = null, newStartDate = null, duration = null, isRenewalOrReactivation = false, priceToCarryOver = null) {
            if (!userId || !db || (auth.currentUser && auth.currentUser.email !== ALLOWED_EMAIL)) { showInPageNotification("خطأ: لا يمكن تحديث الحالة.", 'error'); return; }
            const subDocRef = doc(db, `artifacts/${dynamicAppId}/users/${userId}/subscriptions`, subId); 
            try {
                const updateData = { status: newStatus, updatedAt: serverTimestamp() };
                if (newExpiryDate) updateData.expiryDate = newExpiryDate;
                if (newStartDate) updateData.startDate = newStartDate; 
                if (duration) updateData.subscriptionDurationDays = duration;
                if (isRenewalOrReactivation && newStatus === "active") {
                    updateData.lastRenewedAt = serverTimestamp();
                    if (priceToCarryOver !== null) updateData.price = priceToCarryOver; // Carry over price on renew/reactivate
                }
                await updateDoc(subDocRef, updateData);
                showInPageNotification(`تم تحديث حالة الاشتراك بنجاح.`, 'success');
            } catch (error) { console.error("Error updating status:", error); showInPageNotification(`خطأ تحديث الحالة: ${error.message}`, 'error');}
        }

        const tabButtons = document.querySelectorAll('.tab-button'), tabContents = document.querySelectorAll('.tab-content');
        if (tabButtons.length > 0) {
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => { btn.classList.remove('active-tab','text-indigo-600','border-indigo-600'); btn.classList.add('text-slate-500','hover:text-slate-700','hover:border-slate-400');});
                    button.classList.add('active-tab','text-indigo-600','border-indigo-600'); button.classList.remove('text-slate-500','hover:text-slate-700','hover:border-slate-400');
                    currentVisibleTab = button.getAttribute('data-tab'); tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `${currentVisibleTab}Subscriptions`));
                    renderSubscriptions(); 
                });
            });
        }
        
        if (exportCsvBtn) exportCsvBtn.addEventListener('click', () => {
            const subsToExport = allSubscriptions.filter(sub => sub.status === currentVisibleTab && (sub.phoneNumber.includes(currentFilterQuery) || (sub.notes && sub.notes.toLowerCase().includes(currentFilterQuery))) );
            if (subsToExport.length === 0) { const currentTabButton = document.querySelector(`.tab-button[data-tab="${currentVisibleTab}"]`), tabName = currentTabButton ? currentTabButton.innerText.split(' ')[0] : currentVisibleTab; showInPageNotification(`لا توجد اشتراكات في تبويب "${tabName}" للتصدير.`, 'warning'); return; }
            
            let csvContent = "\uFEFF"; csvContent += "رقم الهاتف,السعر,تاريخ البدء,تاريخ الانتهاء,المدة (أيام),تاريخ آخر تجديد,الحالة,ملاحظات,تاريخ الإنشاء\n";
            const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
            subsToExport.forEach(sub => {
                const price = sub.price || 0; const startDate = sub.startDate ? sub.startDate.toLocaleDateString('ar-EG', dateOptions) : ''; const expiryDate = sub.expiryDate ? sub.expiryDate.toLocaleDateString('ar-EG', dateOptions) : ''; const duration = sub.subscriptionDurationDays || ''; const lastRenewed = sub.lastRenewedAt ? sub.lastRenewedAt.toLocaleDateString('ar-EG', dateOptions) : ''; const createdAt = sub.createdAt ? sub.createdAt.toLocaleDateString('ar-EG', dateOptions) : ''; const notes = (sub.notes || "").replace(/"/g, '""'); 
                csvContent += `"${sub.phoneNumber}","${price}","${startDate}","${expiryDate}","${duration}","${lastRenewed}","${sub.status}","${notes}","${createdAt}"\n`;
            });
            const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", 'data:text/csv;charset=utf-8,' + encodedUri); link.setAttribute("download", `subscriptions_${currentVisibleTab}_${new Date().toISOString().slice(0,10)}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); showInPageNotification("تم تصدير البيانات بنجاح!", "success");
        });

        if (firebaseConfig && firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("YOUR_API_KEY_HERE")) { renderSubscriptions(); }
    </script>
</body>
</html>
